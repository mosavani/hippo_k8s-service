# ============================================================
# hippo-service Helm Chart — Default Values
# ============================================================
# Override per component via:
#   service-settings/default/<component>-values.yml     (non-prod)
#   service-settings/overrides/<component>-values.yml   (prod)
# ============================================================

# ---------------------------------------------------------------------------
# Global — set by the pipeline / cluster config
# ---------------------------------------------------------------------------
global:
  env: dev
  componentName: ""
  # Pipeline can force a specific replica count (0 = use service.replicaCount)
  replicaCountOverride: 0

# ---------------------------------------------------------------------------
# Image
# ---------------------------------------------------------------------------
image:
  repository: ""
  tag: "latest"
  pullPolicy: IfNotPresent

# ---------------------------------------------------------------------------
# Service
# ---------------------------------------------------------------------------
service:
  replicaCount: 2
  revisionHistoryLimit: 3

  # Kubernetes Service type: ClusterIP | LoadBalancer
  # Use ClusterIP when Ingress is enabled, LoadBalancer for direct L4 access.
  type: ClusterIP

  port: 80           # Service port
  targetPort: 8080   # Container port

  # Liveness probe
  liveness:
    enabled: true
    path: /health
    initialDelaySeconds: 15
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  # Readiness probe
  readiness:
    enabled: true
    path: /ready
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Rolling-update strategy
  maxSurge: 1
  maxUnavailable: 0

# ---------------------------------------------------------------------------
# Resources
# ---------------------------------------------------------------------------
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    memory: 256Mi

# ---------------------------------------------------------------------------
# Horizontal Pod Autoscaler
# ---------------------------------------------------------------------------
hpa:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  # Optional memory target (leave empty to disable)
  targetMemoryUtilizationPercentage: ""
  # Seconds before scaling down (prevents thrashing)
  scaleDownStabilizationWindowSeconds: 300

# ---------------------------------------------------------------------------
# Pod Disruption Budget
# ---------------------------------------------------------------------------
pdb:
  enabled: true
  minAvailable: 1

# ---------------------------------------------------------------------------
# Ingress (GKE HTTP(S) LoadBalancer)
# ---------------------------------------------------------------------------
ingress:
  enabled: false
  className: "gce"   # gce = GKE external, gce-internal = GKE internal
  annotations: {}
    # kubernetes.io/ingress.allow-http: "false"
    # networking.gke.io/managed-certificates: my-cert
    # kubernetes.io/ingress.global-static-ip-name: my-static-ip
  host: ""
  path: /
  pathType: Prefix
  tls: []

# ---------------------------------------------------------------------------
# Node Affinity / Pod Anti-Affinity
# ---------------------------------------------------------------------------
affinity:
  # Pod anti-affinity: soft | hard | none
  # soft — prefer different nodes (best-effort)
  # hard — require different nodes (blocks scheduling if not possible)
  podAntiAffinity: soft
  # Optional node pool pin, e.g.:
  #   cloud.google.com/gke-nodepool: high-mem-pool
  nodePool: ""

# ---------------------------------------------------------------------------
# Network Policy
# ---------------------------------------------------------------------------
networkPolicy:
  enabled: true
  # Namespaces allowed to send inbound traffic (by label).
  # Default: only pods in the same namespace.
  # Example: allow from ingress-nginx namespace →
  #   ingressNamespace: ingress-nginx
  ingressNamespace: ""

# ---------------------------------------------------------------------------
# Environment Variables
# ---------------------------------------------------------------------------
env: []
# - name: MY_VAR
#   value: "value"

podAnnotations: {}
podLabels: {}
deploymentAnnotations: {}

# ---------------------------------------------------------------------------
# Argo Rollouts (canary deployments)
# ---------------------------------------------------------------------------
# Set rollout.enabled: true to replace the Deployment with an Argo Rollout.
# Requires the Argo Rollouts controller to be installed in the cluster.
#
# When enabled:
#   - deployment.yaml is suppressed
#   - rollout.yaml + service-rollout.yaml are rendered (stable + canary Services)
#   - hpa.yaml targets the Rollout instead of the Deployment
#
rollout:
  enabled: false

  # autoPromote: true skips all steps and promotes immediately (useful for dev).
  autoPromote: false

  # Percentage caps on surge / unavailable pods during a rollout.
  maxSurge: 25
  maxUnavailable: 0

  # Abort the rollout if it has not progressed within this window (seconds).
  progressDeadlineSeconds: 600
  progressDeadlineAbort: true

  # Canary steps — executed in order.
  # Supported step types: setWeight | pause | analysis
  # Leave empty [] when autoPromote: true.
  steps:
    - setWeight: 20
    - pause:
        duration: 60s
    - setWeight: 50
    - pause:
        duration: 120s
    - setWeight: 100
